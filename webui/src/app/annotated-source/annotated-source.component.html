<section class="layout-page">
    <!-- Annotated source -->
    <div class="layout-page-content">
        <div class="annotated-source-body">
            <nav>
                <h3 class="source-head">
                    <span class="project">
                        <a [routerLink]="['/project-explorer', {
                            project: blob.project, directory: blob.source_dir
                        }]">
                            {{ blob.project }}
                        </a>
                    </span>
                    <span  class="path-divider">/</span>
                    <strong>{{ blob.filename }}</strong>
                </h3>
                <!-- File metrics -->
                <template [ngIf]="blob.metrics | dshNotEmpty">
                    <h4>File metrics</h4>
                    <dl class="dl-horizontal">
                        <template ngFor let-metric [ngForOf]="blob.metrics">
                            <dt class="metric-label">{{ metric.rule.name }}</dt>
                            <dd><span class="metric-value">{{ metric.message }}</span></dd>
                        </template>
                    </dl>
                </template>
                <template [ngIf]="blob.has_messages || blob.has_coverage">
                    <h4>Preferences</h4>
                    <div class="preferences">
                        <table>
                            <tbody>
                            <tr *ngIf="blob.has_messages">
                                <td>
                                    <label>
                                        <input type="checkbox" [(ngModel)]="displayMessages" />
                                        <span>Show messages</span>
                                    </label>
                                </td>
                            </tr>
                            <tr *ngIf="blob.has_coverage">
                                <td>
                                    <label>
                                        <input type="checkbox" [(ngModel)]="displayCoverage" />
                                        <span>Show coverage</span>
                                    </label>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </template>
                <template [ngIf]="displayMessages && messages | dshNotEmpty">
                    <h4>Message filters</h4>
                    <div class="option-selectors">
                        <!-- Tool selector -->
                        <option-selector
                            class="tool-selector" title="Tools"
                            *ngIf="blob.tools | dshNotEmpty"
                            [options]="blob.tools | dshMapValues"
                            [optionCount]="toolMessageCount">
                        </option-selector>
                        <!-- Rule selector -->
                        <option-selector
                            class="rule-selector" title="Rules"
                            *ngIf="blob.rules | dshNotEmpty"
                            [options]="blob.rules | dshMapValues"
                            [optionCount]="ruleMessageCount">
                        </option-selector>
                        <!-- Property selector -->
                        <option-selector
                            class="property-selector" title="Properties"
                            *ngIf="blob.properties | dshNotEmpty"
                            [options]="blob.properties | dshMapValues"
                            [optionCount]="propertyMessageCount">
                        </option-selector>
                    </div>
                </template>
            </nav>
            <main #scrollView>
                <div class="missing-file-content" *ngIf="!blob.lines">
                    <h4>Missing file content</h4>
                    <p>
                        This is most likely due to an error during the HTML report
                        generation.
                    </p>
                </div>
                <div class="file" *ngIf="blob.lines">
                    <div class="file-header">
                        <div class="file-info">
                            {{ blob.lines.length }} lines
                            <template [ngIf]="hasMetric('code_lines')">
                                ({{ getMetricValue('code_lines') }} sloc)
                            </template>
                            <div class="file-info-divider"></div>
                            {{ getMessageDisplayedCount() }} annotations displayed
                        </div>
                    </div>
                    <div class="blob-wrapper">
                        <table class="file-line-container">
                        <tbody>
                            <template ngFor let-line [ngForOf]="blob.lines">
                                <tr [ngClass]="{
                                    selected: selectedLine == line.number,
                                    no_code: coverageAt(line.number)?.status.toLowerCase() == 'no_code',
                                    covered: coverageAt(line.number)?.status.toLowerCase() == 'covered',
                                    not_covered: coverageAt(line.number)?.status.toLowerCase() == 'not_covered',
                                    partially_covered: coverageAt(line.number)?.status.toLowerCase() == 'partially_covered'
                                }">
                                    <td class="blob-num">
                                        <a [routerLink]="['.', { line: line.number }]"
                                           [attr.data-line-number]="line.number">&nbsp;</a>
                                    </td>
                                    <!-- line.content may contain escaped HTML entities.
                                        Use AngularJS embedded sanitizer to render it.  -->
                                    <td id="L{{ line.number }}" class="blob-code"
                                        [innerHTML]="bypassSanitizer(line.html_content)"></td>
                                </tr>
                                <template [ngIf]="displayMessages && hasDisplayableMessage(line.number)">
                                    <tr class="inline-comments">
                                        <td colspan=2>
                                            <inline-messages
                                                [tools]="blob.tools"
                                                [messages]="displayableMessagesAtByTool(line.number)">
                                            </inline-messages>
                                        </td>
                                    </tr>
                                </template>
                            </template>
                        </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>
    <footer
        class="layout-page-footer location-view"
        *ngIf="displayMessages && getMessageDisplayedCount()">
        <div class="location-view-flex">
            <div class="location-view-header">
                <span class="location-view-title">Messages</span>
                <button class="location-view-collapse-btn">
                    <md-icon class="md-18"
                             md-tooltip="Hide/show message list"
                             [ngClass]="{ collapsed: !showMessageList }"
                             (click)="showMessageList = !showMessageList">
                        vertical_align_bottom
                    </md-icon>
                </button>
            </div>
            <div class="location-view-list" *ngIf="showMessageList">
                <table class="file-line-container">
                    <tbody>
                    <template ngFor let-message [ngForOf]="messages">
                        <tr class="message"
                            [ngClass]="{ selected: selectedLine == message.line.number }"
                            *ngIf="shouldDisplayMessage(message.msg)">
                            <td class="line-num">{{ message.line.number }}</td>
                            <td class="line-col">
                                <template [ngIf]="message.msg.begin">
                                    <template [ngIf]="message.msg.begin === message.msg.end">
                                        {{ message.msg.begin }}
                                    </template>
                                    <template [ngIf]="message.msg.begin !== message.msg.end">
                                        {{ message.msg.begin }}-{{ message.msg.end }}
                                    </template>
                                </template>
                            </td>
                            <td class="line-tool">{{ message.msg.rule.tool.name }}</td>
                            <td class="line-msg">
                                <a [routerLink]="['.', { line: message.line.number }]">
                                    {{ message.msg.message }}
                                </a>
                            </td>
                        </tr>
                    </template>
                    </tbody>
                </table>
            </div>
        </div>
    </footer>
</section>
